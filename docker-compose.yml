version: "3.9"
services:
  copyparty:
    image: copyparty/ac:latest
    container_name: copyparty
    restart: unless-stopped
    networks:
      - setups-network
    command:
      - -p
      - "8080"
      - "--rproxy"
      - "1"
      - "--xff-src"
      - "any"
      - "--xf-proto-fb"
      - "https"
      - "--dbd"
      - "wal"
      # --- MINIMALIST UI & PERFORMANCE ---
      - "-s"               # Simple mode (disables media engines)
      - "-nb"              # REMOVE "Powered by Copyparty" branding
      - "-nih"             # REMOVE hostname/server info from UI
      - "-nth"             # REMOVE hostname from browser tab title
      - "--no-zip"         # REMOVE the "Download as Zip" button
      - "--ui-norepl"      # REMOVE the message/chat button
      - "-e2dsa"           # Fast list indexing
      # -----------------------------------
      - "-a"
      - "admin:${COPYPARTY_ADMIN_PASSWORD}"
      - "-a"
      - "apex:${COPYPARTY_APEX_PASSWORD}"
      - "-v"
      # APEX: hanze hidden
      - "/srv/setups/mothervault:mothervault:r,apex:c,noidx=.*[Hh][Aa][Nn][Zz][Ee]_.*:c,hist=/config/hist/apex"
    volumes:
      - /opt/stacks/copyparty/config:/config
      - /opt/stacks/setup-downloader/setups:/srv/setups/mothervault:ro
    environment:
      - COPYPARTY_ADMIN_PASSWORD=${COPYPARTY_ADMIN_PASSWORD}
      - COPYPARTY_APEX_PASSWORD=${COPYPARTY_APEX_PASSWORD}

  setup-downloader:
    image: ghcr.io/michelgerding/setup-downloader:latest
    container_name: setup-downloader
    restart: unless-stopped
    networks:
      - setups-network
    environment:
      - AUTH_URL=${AUTH_URL}
      - SIMDATA_URL=${SIMDATA_URL}
      - DATAPACKS_URL=${DATAPACKS_URL}
      - MEMBER_URL=${MEMBER_URL}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - REFRESH_TOKEN=${REFRESH_TOKEN}
    volumes:
      - /opt/stacks/setup-downloader/setups:/app/setups

  caddy:
    image: caddy:latest
    container_name: caddy-proxy
    restart: unless-stopped
    networks:
      - setups-network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /opt/stacks/caddy/Caddyfile:/etc/caddy/Caddyfile
      - /opt/stacks/caddy/data:/data
      - /opt/stacks/caddy/config:/config

networks:
  setups-network:
    driver: bridge